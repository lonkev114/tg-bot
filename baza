import random
from telegram import Update
from telegram.ext import ApplicationBuilder, CommandHandler, MessageHandler, filters, ContextTypes

# –°–ø–∏—Å–æ–∫ –≤–æ–ø—Ä–æ—Å–æ–≤: (url –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç)
QUESTIONS = [
    {"image": "https://cs6.pikabu.ru/post_img/big/2015/06/08/3/1433735650_472905306.jpg", "answer": "–ö–∞–Ω–∞–¥–∞"},
    {"image": "https://avatars.mds.yandex.net/i?id=1d87c6b82ed2dd2f78e71c4c45b3d427_l-4575726-images-thumbs&n=13", "answer": "–õ–æ–Ω–¥–æ–Ω"},
    {"image": "https://avatars.mds.yandex.net/i?id=2fae17ed7a2c1e5ad7c9dfec42752b03_l-5234566-images-thumbs&n=13", "answer": "–ò—Ç–∞–ª–∏—è"},
    {"image": "https://udoba.org/sites/default/files/h5p/content/42525/images/collageClip-62ab6b52e80d3.jpg", "answer": "–§—Ä–∞–Ω—Ü–∏—è"},
    {"image": "https://s.yimg.com/ny/api/res/1.2/jvkzkQLZ51wXmHswNTiktg--/YXBwaWQ9aGlnaGxhbmRlcjt3PTEyMDA7aD04MDA-/https://s.yimg.com/os/creatr-uploaded-images/2021-07/59a4bc60-f23c-11eb-bf75-c38993010fb7", "answer": "–¢–æ–∫–∏–æ"},
    {"image": "https://avatars.mds.yandex.net/get-entity_search/9708398/959738716/orig", "answer": "–ë–µ—Ä–ª–∏–Ω"}
]

# –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: —Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–π –≤–æ–ø—Ä–æ—Å –∏ –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –≤–æ–ø—Ä–æ—Å—ã
user_data = {}

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("–ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç-–≤–∏–∫—Ç–æ—Ä–∏–Ω–∞. –£–≥–∞–¥–∞–π –≥–æ—Ä–æ–¥ –∏–ª–∏ —Å—Ç—Ä–∞–Ω—É –ø–æ –∫–∞—Ä—Ç–∏–Ω–∫–µ. –ù–∞—á–∏–Ω–∞–µ–º!")
    await send_next_question(update.effective_user.id, update.effective_chat.id, context)

async def send_next_question(user_id, chat_id, context):
    if user_id not in user_data or not user_data[user_id]['remaining']:
        user_data[user_id] = {
            'remaining': QUESTIONS.copy(),
            'current': None
        }
        random.shuffle(user_data[user_id]['remaining'])

    question = user_data[user_id]['remaining'].pop()
    user_data[user_id]['current'] = question

    await context.bot.send_photo(chat_id=chat_id, photo=question["image"])
    await context.bot.send_message(chat_id=chat_id, text="–ü–æ–ø—Ä–æ–±—É–π —É–≥–∞–¥–∞—Ç—å —ç—Ç–æ—Ç –≥–æ—Ä–æ–¥ –∏–ª–∏ —Å—Ç—Ä–∞–Ω—É:")

async def handle_answer(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    chat_id = update.effective_chat.id

    if user_id not in user_data or not user_data[user_id]['current']:
        await update.message.reply_text("–°–Ω–∞—á–∞–ª–∞ –Ω–∞–ø–∏—à–∏ /start, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∏–≥—Ä—É!")
        return

    user_input = update.message.text.strip().lower()
    correct_answer = user_data[user_id]['current']['answer'].strip().lower()

    # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–¥–∞–ª—Å—è
    if user_input == "–µ—â—ë —Ä–∞–∑!":
        await update.message.reply_text("–ê —Ç—ã —É–º—ë–Ω!")

    if user_input in ["—Å–¥–∞—é—Å—å", "–Ω–µ –∑–Ω–∞—é", "–Ω–µ —É–≥–∞–¥–∞–ª"]:
        await update.message.reply_text(f"üòÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: {user_data[user_id]['current']['answer']}")
        user_data[user_id]['current'] = None

    elif user_input == correct_answer:
        await update.message.reply_text("‚úÖ –í–µ—Ä–Ω–æ!")
        user_data[user_id]['current'] = None
    else:
        await update.message.reply_text("‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑! –ò–ª–∏ –Ω–∞–ø–∏—à–∏ '—Å–¥–∞—é—Å—å'.")
        return  # –ù–µ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –∏–≥—Ä—É, –∂–¥—ë–º —Å–ª–µ–¥—É—é—â—É—é –ø–æ–ø—ã—Ç–∫—É

    # –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –≤–æ–ø—Ä–æ—Å—É
    await send_next_question(user_id, chat_id, context)

if __name__ == "__main__":
    TOKEN = "7575468144:AAGKSroDpaRj5-ybUPLYcuPIRviM1P2P58M"

    app = ApplicationBuilder().token(TOKEN).build()

    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.TEXT & (~filters.COMMAND), handle_answer))

    print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω...")
    app.run_polling()
